---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup-hourly
  namespace: bae
spec:
  # 매 정시마다 실행 (1시간 간격, 서버 타임존은 UTC)
  # => 한국 시간 기준으로는 매 정시 9분 차이 없이 도는 느낌 (UTC+9)
  schedule: "0 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3

  jobTemplate:
    spec:
      backoffLimit: 1                 # 실패 시 1번만 재시도 (디버깅용)
      ttlSecondsAfterFinished: 3600   # 완료 후 1시간 동안 Job/Pod 유지

      template:
        spec:
          hostNetwork: true
          restartPolicy: OnFailure

          # 컨트롤 플레인 노드에서만 실행
          nodeSelector:
            node-role.kubernetes.io/control-plane: ""
          tolerations:
          - key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"

          containers:
          - name: etcd-backup
            image: registry.k8s.io/etcd:3.5.13-0   # 클러스터 etcd 버전에 맞게 필요시 수정
            imagePullPolicy: IfNotPresent
            env:
            - name: ETCDCTL_API
              value: "3"

            command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail

              etcd_dir=/var/lib/etcd/etcd_backup
              mkdir -p "${etcd_dir}"

              TS=$(date +%Y%m%d%H%M%S)
              SNAPSHOT_FILE="${etcd_dir}/etcd-snapshot-${TS}.db"

              echo "[$(date)] ${SNAPSHOT_FILE} 스냅샷 생성 시작"

              etcdctl \
                --endpoints=https://127.0.0.1:2379 \
                --cacert=/etc/kubernetes/pki/etcd/ca.crt \
                --cert=/etc/kubernetes/pki/etcd/server.crt \
                --key=/etc/kubernetes/pki/etcd/server.key \
                snapshot save "${SNAPSHOT_FILE}"

              echo "==> 스냅샷 저장 완료, 상태 확인 중..."

              etcdctl \
                --write-out=table \
                snapshot status "${SNAPSHOT_FILE}"

              echo "==> etcd 스냅샷 작업 완료"

            volumeMounts:
            - name: etcd-certs
              mountPath: /etc/kubernetes/pki/etcd
              readOnly: true
            - name: etcd-backup-dir
              mountPath: /var/lib/etcd/etcd_backup

          volumes:
          - name: etcd-certs
            hostPath:
              path: /etc/kubernetes/pki/etcd
              type: DirectoryOrCreate
          - name: etcd-backup-dir
            hostPath:
              path: /var/lib/etcd/etcd_backup
              type: DirectoryOrCreate