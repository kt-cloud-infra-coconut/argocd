apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-app-deployment
  namespace: ingress-myweb
spec:
  replicas: 3
  selector:
    matchLabels:
      app: php-app
  template:
    metadata:
      labels:
        app: php-app
    spec:
      volumes:
        # 1. PHP ì½”ë“œ ConfigMap ë³¼ë¥¨ (index.php)
        - name: app-code-volume
          configMap:
            name: php-index-file # ğŸ‘ˆ kustomization.yamlì—ì„œ ì •ì˜ëœ ì´ë¦„
        # 2. Nginx ì„¤ì • ConfigMap ë³¼ë¥¨ (default.conf)
        - name: nginx-config-volume
          configMap:
            name: nginx-config   # ğŸ‘ˆ kustomization.yamlì—ì„œ ì •ì˜ëœ ì´ë¦„
            
      containers:
      # ----------------------------------------------------
      # 1. PHP-FPM ì»¨í…Œì´ë„ˆ (PHP ì½”ë“œ ì‹¤í–‰ê¸°)
      # ----------------------------------------------------
      - name: php-fpm
        image: eunjun0122/myapp:1.1.0 
        ports:
        - containerPort: 9000
        volumeMounts:
        # PHP ì½”ë“œë¥¼ ì›¹ ë£¨íŠ¸ì— ë§ˆìš´íŠ¸
        - name: app-code-volume
          mountPath: /var/www/html 
        # ConfigMapìœ¼ë¡œ ë§ˆìš´íŠ¸ëœ íŒŒì¼ì˜ ê¶Œí•œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ fsGroupì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
        # ê·¸ëŸ¬ë‚˜ í˜„ì¬ëŠ” ê°„ë‹¨í•œ ì„¤ì •ì„ ìœ„í•´ ìƒëµí•©ë‹ˆë‹¤.
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"

      # ----------------------------------------------------
      # 2. Nginx ì»¨í…Œì´ë„ˆ (ì›¹ ì„œë²„ & ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ)
      # ----------------------------------------------------
      - name: nginx
        image: nginx:stable-alpine
        ports:
        - containerPort: 80
        volumeMounts:
        # PHP ì½”ë“œë¥¼ Nginx ì›¹ ë£¨íŠ¸ì— ë§ˆìš´íŠ¸ (PHP-FPMê³¼ ë™ì¼ ê²½ë¡œ)
        - name: app-code-volume
          mountPath: /var/www/html 
        # Nginx ì„¤ì • íŒŒì¼ì„ ê¸°ë³¸ ì„¤ì • íŒŒì¼ ê²½ë¡œì— ë®ì–´ì”Œì›ë‹ˆë‹¤.
        - name: nginx-config-volume
          mountPath: /etc/nginx/conf.d/default.conf 
          subPath: default.conf # ConfigMapì˜ í•­ëª© ì´ë¦„ê³¼ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"

---
# php/php-service.yaml (Service ì •ì˜)
apiVersion: v1
kind: Service
metadata:
  name: php-service
  namespace: ingress-myweb
spec:
  type: ClusterIP
  selector:
    app: php-app
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80